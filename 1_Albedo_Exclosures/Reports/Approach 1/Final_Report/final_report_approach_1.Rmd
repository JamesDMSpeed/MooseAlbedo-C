---
output:
  html_document:
    self_contained: false
    lib_dir: libs
    css: styles.css
    toc: true
    df_print: paged
    number_sections: false
    theme: paper
    toc_float:
      collapsed: true
      smooth_scroll: true
    includes:
      before_body: markdown_intro.html
---

```{r echo = FALSE, results = "asis", message = FALSE, include = FALSE}

#Packages
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(sp)
library(raster)
library(GGally)
library(lattice)
library(lme4)
library(sjPlot)

#Data Filtering

        #Import CSV to dataframe
        data <- read.csv('../../../Data/Tree_Data/sustherb_tree_data.csv', header = TRUE)
        
        #Filter to 'Trøndelag' region only
        ##NOTE: This reduces the number of study sites (LocalityName) to 15 (w/ 30 total plots)
        trondelag <- data[data$Region == 'Trøndelag',]
        
        #Format date column properly (to R date format)
        trondelag$X_Date <- as.Date(as.character(trondelag$X_Date), format = "%m/%d/%y")
        
        #Format LocalityName and LocalityCode as factors
        trondelag$LocalityCode <- as.factor(trondelag$LocalityCode)
        trondelag$LocalityName <- as.factor(trondelag$LocalityName)
        
        #LocalityName to lowercase
        trondelag$LocalityName <- tolower(trondelag$LocalityName)
        
        #Filter to data from year 2016 only 
        t2016 <- trondelag[trondelag$X_Date >= "2016-01-01" & trondelag$X_Date <= "2016-12-31",]
        
        #Remove rows that are missing diameter-at-base data (3 total)
        removed <- t2016[is.na(t2016$Diameter_at_base_mm), ]
        t2016 <- t2016[! is.na(t2016$Diameter_at_base_mm), ]
        
        #Exclude trees > 6m (600cm)
        t2016 <- t2016[t2016$Height_cm <= 600,]
        
        #Check on Juniperus communis distribution between treatments - does one treatment have much more than the other?
        taxa_table <- as.matrix(table(t2016$Taxa, t2016$Treatment))
        
        #Volume
        t2016$Volume_m3 <- as.numeric(c(''))
        
        #Biomass
        t2016$Biomass_g <- as.numeric(c(''))
        
        
#SPECIFIC WOOD DENSITIES TO CONVERT BIOMASS TO VOLUME
        ##Note: These are average wood densities for spruce, pine, and birch - provided by Repola (2006)
        
                #This will likely be a major source of error - according to Repola (2006), density varies widely vertically
        
                #Spruce density (kg/m3 converted to g/cm3)
                s_density <- 385.3 / 1000
                
                #Pine density (kg/m3 converted to g/cm3)
                p_density <- 412.6 / 1000
                
                #Birch density (kg/m3 converted to g/cm3)
                b_density <- 475 / 1000
        
        #Loop through each row of the dataframe (2016, Trøndelag, <6m height) and produce a volume estimate
        for(row in 1:nrow(t2016)){
                
                #IDENTIFY SPECIES + HEIGHT
                
                        #Get tree species
                        species <- as.character(t2016[row, "Taxa"])

                        #Get 'Diameter at Ground Level' (mm)
                        dgl <- as.numeric(t2016[row, "Diameter_at_base_mm"])
        
                        #Get height (cm)
                        height <- as.numeric(t2016[row, "Height_cm"])

                #CALCULATE BIOMASS FOR EACH TREE USING SUSTHERB ALLOMETRIC EQUATIONS
                
                        #Betula pubescens model (Birch)
                        if( species == "Betula pubescens (Bjørk)" || species == "Betula pendula (Lavlandbjørk)" || species == "Salix caprea (Selje)" ){
                                
                                #Biomass (g)
                                biomass <- (0.078843)*(dgl^2) + (0.009197)*(height^2)
                                
                                #Volume (cm3 converted to m3)
                                volume <- (biomass / b_density) / 1e06
                                
                        }
                        
                        #Picea abies model (Spruce)
                        else if( species == "Picea abies (Gran)" || species == "Juniperus communis (Einer)"){
                                
                                #Biomass (g)
                                biomass <- (0.020293)*(height^2) + (0.006092)*(dgl^3)
                                
                                #Volume (cm3 converted to m3)
                                volume <- (biomass / s_density) / 1e06
                                
                        }
                        
                        #Pinus sylvestris model (Pine)
                        else if( species == "Pinus sylvestris (Furu)" ){
                                
                                #Biomass (g)
                                biomass <- (0.325839)*(dgl^2) + (0.0007434)*(dgl^3)
                                
                                #Volume (cm3 converted to m3)
                                volume <- (biomass / p_density) / 1e06
                                
                        }
                        
                        #Sorbus aucuparia model (Rowan)
                        else if( species == "Sorbus aucuparia (Rogn)" ){
                                
                                #Treatment
                                treatment <- as.character(t2016[row, "Treatment"])
                                
                                #Browsed Model
                                if( treatment == "B" ){
                                        
                                        #Biomass (g)
                                        biomass <- (0.006664)*(height^2) + (0.082983)*(dgl^2)
                                        
                                }
                                
                                #Unbrowsed Model
                                if( treatment == "UB" ){
                                        
                                        #Biomass (g)
                                        biomass <- (0.0053962)*(height^2)
                                        
                                }
                                
                                #Volume (cm3 converted to m3)
                                #Using birch average specific wood density from Repola (2006)
                                volume <- (biomass / b_density) / 1e06
                                
                        }
                        
                        #Add calculated biomass to 'Biomass' column
                        t2016[row, "Biomass_g"] <- biomass
                        
                        #Add calculated volume to 'Volume' column
                        t2016[row, "Volume_m3"] <- volume
                        
                                
                
        }
        
        #Ensure that 'Volume' & 'Biomass' columns are numeric
        t2016$Volume_m3 <- as.numeric(t2016$Volume_m3)
        t2016$Biomass_g <- as.numeric(t2016$Biomass_g)
        
        agg_trees <- aggregate(t2016$Volume_m3, by = list(LocalityName = t2016$LocalityName, LocalityCode= t2016$LocalityCode, Taxa = t2016$Taxa, Treatment = t2016$Treatment), FUN = sum)
        names(agg_trees)[5] <- "Volume_m3"
        
```

# Overview
This report contains a summary of 'Approach 1', which uses SustHerb biomass equations to estimate volume (and ultimately, albedo) for relevant study plots. The report covers each step of the analysis and discusses potential limitations/assumptions associated with each step.

![](https://allyworks.io/moose-albedo/img/Approach_1_Flowchart.png)

***

# Data

### Data Selection {.tabset .tabset-fade .tabset-pills}

#### SustHerb Data
I chose to use data from SustHerb sites in Trøndelag from the year 2016 **(15 study sites with 3396 tree observations)**. This subset appears to be the only data with detailed measurements for *diameter at ground level (DGL)* and *height*, both of which are necessary for the locally-calibrated allometric biomass equations that were created by [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4).

3 tree observations were removed from the dataset, as these observations didn’t have any associated DGL or height measurements (and thus, couldn’t be used to calculate albedo in subsequent steps). Additionally, 2 observations of trees with a height greater than 600cm (6m) were removed, as these were likely left over from forestry operations. 6m is the height threshold used by [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4). **The total number of tree observations for this approach is therefore 3391**.

I also included "years since clearcut" data for each SustHerb site included in this approach. Many of the sites were clearcut at different times, and therefore, are in varying stages of succession.

#### seNorge Climate Data
The albedo model developed by [Hu et al. (2018)](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2018MS001403) accepts *two climate parameters*: (1) monthly average snow-water equivalent (mm) and (2) monthly average temperature (K). seNorge provides this data across the entire country of Norway in the form of spatially-gridded daily estimates with a 1km2 resolution. Thus, it was possible to use obtain relevant time series data for each study site used in this approach.

Each time series was filtered to the year 2016 in order to align with the dates of corresponding tree observations. Monthly averages of temperature (C) and snow-water equivalent (mm) were calculated from each time series. Temperature was converted to K for use with the albedo model. **The total number of temperature observations is therefore 180 (12 months x 15 sites). The total number of snow-water equivalent observations is also 180 (12 months x 15 sites)**.

#### Productivity Index
Site productivity is likely an important variable to control for when attempting to determine the effect of moose exclusion on forest surface albedo. Therefore, I decided to include data from the site productivity index that was developed by [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4). This index is based upon a standardized value for mean annual increment in aboveground biomass. 

#### Herbivore Densities
Densities of various herbivores may have important effects on vegetation states within forest ecosystems, and therefore, it is likely relevant to control for relevant herbivore densities in our final analysis. In addition to moose, both red deer and roe deer are important herbivores in Norwegian boreal forests. Thus, I decided to include densities of moose, red deer, and roe deer in the final model for this approach.

[Speed et al. (2019)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0217166) and [Austrheim et al. (2011)](https://bioone.org/journals/Wildlife-Biology/volume-17/issue-3/10-038/Spatio-temporal-variation-in-large-herbivore-pressure-in-Norway-during/10.2981/10-038.full) calculated metabolic biomass (kg/km2) of many different large herbivores in each Norwegian municipality (for 1949, 1959, 1969, 1979, 1989, 1999, 2009, and 2015), which allows us to include herbivore densities as covariates in our final model. Because this specific approach is using tree data from 2016, I decided to use herbivore data from the closest possible year (2015). For each Sustherb site, I pulled herbivore densities for the corresponding Norwegian kommune based on "Kommune ID".

#### Forest Canopy MAD
Surface roughness (and therefore forest canopy roughness) may be an important factor in surface albedo. [Snøan (2019)](https://ntnuopen.ntnu.no/ntnu-xmlui/handle/11250/2618099?locale-attribute=no) used airborne laser measurements (LiDAR) to examine the effects of moose exclusion on boreal forest canopy, and found that moose exclusion significantly altered forest canopy mean absolute deviation (MAD), which is a metric for canopy roughness. Therefore, I decided to include the LiDAR-derived canopy MAD measurements produced by [Snøan (2019)](https://ntnuopen.ntnu.no/ntnu-xmlui/handle/11250/2618099?locale-attribute=no) in the final analysis for this approach.

### Data Summary {.tabset .tabset-fade .tabset-pills}

#### SustHerb Dataset {.tabset}

##### Summary
```{r echo = FALSE, eval= TRUE, message = FALSE}

        #Taxa Table
        kable(taxa_table, caption = "Tree Species Counts by Treatment") %>% kable_styling()

```

##### Tree Heights
```{r echo = FALSE, eval= TRUE, message = FALSE}        
        #Barplot of % species by treatment (faceted by species)
        ggplot(data = t2016, aes(x = Height_cm, fill = Treatment)) +
                geom_histogram(aes(y=..density..), bins = 30, alpha=1, position="identity") +
                geom_density(alpha= 0.5) +
                facet_wrap(~ Taxa) +
                ggtitle("Distribution of Tree Heights by Species & Treatment") +
                labs(x = "Height (cm)", y = "Count")
        
```

##### Tree DGL
```{r echo = FALSE, eval= TRUE, message = FALSE}        
        #Barplot of % species by treatment (faceted by species)
        ggplot(data = t2016, aes(x = Diameter_at_base_mm, fill = Treatment)) +
                geom_histogram(aes(y=..density..), bins = 30, alpha=1, position="identity") +
                geom_density(alpha= 0.5) +
                facet_wrap(~ Taxa) +
                ggtitle("Distribution of Tree DGL by Species & Treatment") +
                labs(x = "DGL (mm)", y = "Count")
        
```

##### Tree Species Proportions
```{r echo = FALSE, eval= TRUE, message = FALSE}   
        
        #Tree density data for Trøndelag, Telemark, and Hedmark (including 2019 data)
        tree_data <- read.csv('../../../Universal/Output/Tree_Species_Proportions/tree_species_proportions_plot_level.csv', header = TRUE)
        
        tree_data <- tree_data[,2:7]
                
        #Filter tree data to 2016 (to correspond with detailed SUSTHERB tree data)
        tree_data <- tree_data[tree_data$Year == 2016,]
        
        #Read in plot volumes
        subplot_sums <- read.csv('../../../Approach_1/Output/Tree_Volumes/tree_volumes_approach_1.csv')

                #Make sure data has correct class
                subplot_sums$Volume_m3 <- as.numeric(subplot_sums$Volume_m3)
                subplot_sums$Treatment <- as.factor(subplot_sums$Treatment)
                
                #Fix Singsås string
                subplot_sums$LocalityName[subplot_sums$LocalityName == "singsås"] <- "singsaas"

        #Filter out unused SustHerb sites (since detailed 2016 tree data is only available in Trondelag)

                #Convert site codes to factors
                tree_data$LocalityCode <- as.factor(tree_data$LocalityCode)
                subplot_sums$LocalityCode <- as.factor(subplot_sums$LocalityCode)
                
                #Get vector of levels for sites that will be used
                used_sites <- levels(subplot_sums$LocalityCode)
        
                #Filter tree data to used sites
                tree_data <- tree_data[tree_data$LocalityCode %in% used_sites,]
                tree_data$LocalityCode <- as.factor(as.character(tree_data$LocalityCode))
                
                tree_data
```

#### seNorge Data {.tabset}

##### Snow-Water Equivalent
```{r echo = FALSE, eval= TRUE, message = FALSE}        
        
        #Add monthly SWE averages from seNorge
        swe <- read.csv('../../../Universal/Output/2016_Climate_Data/monthly_avg_swe_2016.csv', header = TRUE)
                
        #Add monthly temperature averages from seNorge
        temps <- read.csv('../../../Universal/Output/2016_Climate_Data/monthly_avg_temp_2016.csv', header = TRUE)

                #Convert temps from celsius (C) to kelvin (K)
                for( i in 1:length(temps$X)){
                        #K = C + 273.15
                        temps[i, "Avg_Temp_C"] <- temps[i, "Avg_Temp_C"] + 273.15
                }
        
                #Rename column from C to K
                colnames(temps)[9] <- "Avg_Temps_K"
                
        #Remove sites not used in analysis
        t2016$LocalityName <- as.factor(t2016$LocalityName)
        swe$LocalityName <- as.factor(tolower(swe$LocalityName))
        temps$LocalityName <- as.factor(tolower(temps$LocalityName))
        checklist <- levels(t2016$LocalityName)
        swe_filtered <- swe[swe$LocalityName %in% checklist,]
        temps_filtered <- temps[temps$LocalityName %in% checklist,]
        
        #Plot
        ggplot(data = swe_filtered, aes(x = SWE_mm)) +
                geom_histogram(bins = 20) +
                facet_wrap(~ Month) +
                ggtitle("Distribution of Avg. SWE by Month") +
                labs(x = "Avg. SWE (mm)", y = "Count")
        
        swe_filtered$Month <- as.factor(swe_filtered$Month)
        ggplot(data = swe_filtered, aes(x = Month, y = SWE_mm)) +
                geom_boxplot() +
                ggtitle("Avg. SWE by Month") +
                labs(x = "Month", y = "Avg. SWE (mm)")
        
```

##### Temperature
```{r echo = FALSE, eval= TRUE, message = FALSE}        

        #Plot
        ggplot(data = temps_filtered, aes(x = Avg_Temps_K)) +
                geom_histogram(bins = 20) +
                facet_wrap(~ Month) +
                ggtitle("Distribution of Avg. Temperature by Month") +
                labs(x = "Avg. Temperature (K)", y = "Count")

        temps_filtered$Month <- as.factor(temps_filtered$Month)
        ggplot(data = temps_filtered, aes(x = Month, y = Avg_Temps_K)) +
                geom_boxplot() +
                ggtitle("Avg. Temperature by Month") +
                labs(x = "Month", y = "Avg. Temperature (K)")


        
```

#### Productivity Index
```{r echo = FALSE, eval = TRUE, message = FALSE}

#Productivity Data
productivity <- read.csv('../../../Data/SustHerb_Site_Data/productivity_all_sites.csv', header = TRUE)
productivity$LocalityName <- tolower(productivity$LocalityName)

        #Correct LocalityName items in productivity CSV
        
                #Didrik Holmsen
                productivity$LocalityName[productivity$LocalityName == "didrik holmsen"] <- "didrik_holmsen"
                
                #Fet 3
                productivity$LocalityName[productivity$LocalityName == "fet 3"] <- "fet_3"
                
                #Fritsøe 1
                productivity$LocalityName[productivity$LocalityName == "fritsøe1"] <- "fritsoe1"
                
                #Fritsøe 2
                productivity$LocalityName[productivity$LocalityName == "fritsøe2"] <- "fritsoe2"
                
                #Halvard Pramhus
                productivity$LocalityName[productivity$LocalityName == "halvard pramhus"] <- "halvard_pramhus"
                
                #Singsaas
                productivity$LocalityName[productivity$LocalityName == "singsås"] <- "singsaas"
                
                #Stangeskovene Aurskog
                productivity$LocalityName[productivity$LocalityName == "stangeskovene aurskog"] <- "stangeskovene_aurskog"
                
                #Stangeskovene Eidskog
                productivity$LocalityName[productivity$LocalityName == "stangeskovene eidskog"] <- "stangeskovene_eidskog"
                
                #Stig Dahlen
                productivity$LocalityName[productivity$LocalityName == "stig dæhlen"] <- "stig_dahlen"
                
                #Truls Holm
                productivity$LocalityName[productivity$LocalityName == "truls holm"] <- "truls_holm"
        
        #Create corrected version of checklist
        checklist2 <- checklist
        checklist2[9] <- "singsaas"
        
        #Remove LocalityNames not in tree dataset
        productivity <- productivity[productivity$LocalityName %in% checklist2,]
        prod_display <- productivity[,2:4]
        
        prod_display
        
        ggplot(data = prod_display, aes(x = Productivity)) +
                geom_histogram(aes(y=..density..), bins = 15, alpha=1, position="identity") +
                geom_density(alpha= 0.5) +
                ggtitle("Productivity Index Across SustHerb Sites") +
                labs(x = "Productivity Index (0-1)", y = "Density")
        
```

#### Herbivore Densities
```{r echo = FALSE, eval = TRUE, message = FALSE}

        #Read in herbivore biomass data (2015) from SpatialPolygons object (isolate dataframe)
        hbiomass_shp <- shapefile("../../../Data/Herbivore_Densities/NorwayLargeHerbivores")
        
        #Pull out dataframe
        hbiomass <- hbiomass_shp@data
        
        #Isolate to 2015 data
        hbiomass2015<- cbind(hbiomass[,c(1:10)], hbiomass$Ms_2015, hbiomass$Rd__2015, hbiomass$R_d_2015)
        
        #Get 'cleaned' site data from adjacent 'Sites' folder
        site_data <- read.csv('../../../Data/SustHerb_Site_Data/cleaned_data/cleaned_data.csv', header = TRUE)
        sites_df <- site_data[site_data$LocalityName %in% checklist2,]
        sites_df$DistrictID <- as.factor(sites_df$DistrictID)
        kommunes <- levels(sites_df$DistrictID)
        
        #Filter to relevant kommunes
        hbiomass_filt <- hbiomass2015[hbiomass2015$KOMMUNE %in% kommunes, c(1, 4, 11:13)]
        colnames(hbiomass_filt)[3] <- "Moose_Density"
        colnames(hbiomass_filt)[4] <- "Red_Deer_Density"
        colnames(hbiomass_filt)[5] <- "Roe_Deer_Density"
        
                #Get into uniform df
                bio_df <- hbiomass_filt[,2:3]
                bio_df$Herbivore <- "Moose"
                colnames(bio_df)[2] <- "Metabolic Density"
                
                bio_df2 <- hbiomass_filt[,c(2,4)]
                bio_df2$Herbivore <- "Red Deer"
                colnames(bio_df2)[2] <- "Metabolic Density"
                
                bio_df3 <- hbiomass_filt[,c(2,5)]
                bio_df3$Herbivore <- "Roe Deer"
                colnames(bio_df3)[2] <- "Metabolic Density"
                
                bio_df4 <- rbind(bio_df, bio_df2, bio_df3)
        
        ggplot(data = bio_df4, aes(x = Herbivore, y = `Metabolic Density`)) +
                geom_boxplot() +
                ggtitle("Herbivore Densities Across Kommunes With SustHerb Sites") +
                labs(x = "Herbivore", y = "Metabolic Density (kg/km2)")
                
        
```

***

#Volume Calculations {.tabset .tabset-fade .tabset-pills}

## Reasoning 

##### Using existing volume equations:
**The goal with this step was to calculate volume for each tree in the dataset**. These volumes would then be summed at the plot level and used to estimate albedo for each plot. Initially, I wanted to use species-specific *allometric tree volume equations*, which were developed by the Norwegian National Forest Inventory (NFI) for use in Norway. In fact, these equations were used to calculate forest stand volume for the test plots on which the volume parameter of the [SatSkog data product](https://www.nibio.no/tema/skog/kart-over-skogressurser/satskog) is based upon. FYI - the albedo model developed by [Hu et al. (2018)](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2018MS001403) is based upon the SatSkog product. The equations are available in the form of an R package called ["sitreeE"](https://www.rdocumentation.org/packages/sitreeE/versions/0.0-5), but are based on volume tables developed by [Braastad (1966)](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C5&q=Braastad+%281966%29&btnG=), [Brantseg (1967)](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C5&q=+Brantseg+%281967%29&btnG=), and [Vestjordet (1967)](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C5&q=+Vestjordet+%281967%29&btnG=).

However, after testing these equations on the dataset, I found that most estimates of volume (especially those for trees <150cm in height) were negative or obviously erroneous. It seems that the NFI allometric volume equations only perform well for trees that have a certain height or diameter, and wouldn't be useful for the dataset that we have.

I also investigated other allometric volume equations specific to Norwegian tree species of interest. The online database [GlobAllomeTree](http://www.globallometree.org/) contains many relevant equations. However, most of these equations require a *diameter at breast height (DBH)* measurement, as opposed to a DGL measurement (which is what a majority of trees in the dataset have). Additionally, a review by [Zianis et al. (2005)](https://www.researchgate.net/publication/232304857_Biomass_and_stem_volume_equations_of_tree_species_in_Europe) shows that almost all allometric volume equations for species of interest are limited to trees with a diameter of several centimeters or a height of 1.5 meters.

**Key point: using existing allometric volume equations doesn't seem possible for this approach.**

##### Converting from biomass to volume:
Without more detailed and impractical data (such as measurements of trunk diameter at evenly-spaced intervals along each tree), other methods of calculating volume didn't seem to be possible. However, [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4) previously produced species-specific, locally-calibrated allometric biomass models. I thought that we could use these models to calculate biomass (g) for each tree in the dataset, and then somehow convert that biomass to volume (m3). 

There is abundant literature which focuses on converting tree volume to biomass (for carbon accounting purposes). However, I have not been able to find relevant literature related to converting tree *biomass to volume*. My first thought was that if we knew wood density for each tree species of interest, we could use the simple equation $Volume = mass / density$ to estimate volume from biomass. 

However, using wood density in this manner may be substantially flawed. [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618) found that vertical wood density gradients are present in Norwegian species of interest - that is, wood density changes throughout the vertical length of a given tree trunk. Thus, attempting to calculate tree volume from a single wood density value may produce innacurate volume estimates and introduce substantial error into subsequent steps of the approach. Despite this issue, there didn't seem to be a better way to calculate volume for each tree from available data. 

For the wood densities (also sometimes referred to as 'specific gravities'), I chose to use the "**measured densities**" from [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618). These densities were produced by measuring the density of 2-3cm disks taken at a 1m interval for the entire length of 327 pine, 317 spruce, and 192 birch specimens (harvested in Finland, not Norway). For each species, densities were averaged to produce a corresponding "measured density".

It is important to note that DBH of trees sampled by [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618) ranged from 5-48 cm. Additionally, the minimum age of trees sampled was estimated to be 20 years old. These sample characteristics ultimately represent another source of error - most of the trees in the SustHerb dataset are much smaller and younger, and therefore, may have completely different densities than those provided by [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618).

**Key point: best option to calculate volume seemed to be $Volume = mass/density$. Densities taken from [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618)**

##### Handling less-common species
The dataset includes observations of two species - *Juniperus communis* and *Salix caprea* - which don't have corresponding allometric equations and are less common than the main species of interest. For the purposes of this approach, I essentially categorized *J. communis* to be the same as *Picea abies* - the allometric biomass equations and wood densities specific to *P. abies* are used on all observations of *J. communis*. I didn't have a great justification for lumping *J. communis* together with *P. abies* as opposed to *Pinus sylvestris* - only that *J. communis* is coniferous and may have smaller needles which are more similar to those of *P. abies*.

I also categorized *S. caprea* together with *Betula sp.* - the allometric equations and wood densities specific to *Betula sp.* are used on all observations of *S. caprea*. Again, I didn't really have a great justification for lumping *S. caprea* together with *Betula sp.* instead of *Sorbus aucuparia* - only that *S. caprea* and *Betula sp.* are both deciduous.

> What is your opinion regarding my grouping of *J. communis* with *P. abies* and *S. caprea* with *Betula sp.*, as described above? Any suggestions?


## Methods

1. Looped through each individual tree observation in the filtered dataset
2. Calculated biomass (g) for each tree using the locally-calibrated allometric equations developed by [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4):
    + *Betula pubescens, Betula pendula, & Salix caprea*:
        + $Biomass = 0.078843(dgl^2)+0.009197(height^2)$
    + *Picea abies & Juniperus communis*
        + $Biomass = 0.020293(height^2)+0.006092(dgl^3)$
    + *Pinus sylvestris*
        + $Biomass = 0.325839(dgl^2)+0.0007434(dgl^3)$
    + *Sorbus aucuparia* (in browsed plots)
        + $Biomass = 0.006664(height^2)+0.082983(dgl^2)$
    + *Sorbus aucuparia* (in exclosures)
        + $Biomass = 0.0053962(height^2)$
3. From biomass (g) for each tree, I calculated volume (cm3) by using the simple equation: $Volume = mass/density$. I chose to use average 'measured densities' for *Betula sp.*, *P. abies*, and *P. sylvestris*, which were calculated by [Repola (2006)](https://jukuri.luke.fi/handle/10024/532618). Densities were converted from kg/m3 to g/cm3 for this step:
    + *Betula pubescens, Betula pendula, Salix caprea, & Sorbus aucuparia*:
        + Density: 475.0 kg/m3
    + *Picea abies & Juniperus communis*
        + Density: 385.3 kg/m3
    + *Pinus sylvestris*
        + Density: 412.6 kg/m3
4. Volume (cm3) was converted to m3 for use in the albedo model
5. The volumes (m3) of each tree were aggregated and summed by plot, in order to produce plot-level volume estimates. **Note:** a given plot-level volume estimate is the sum of all corresponding circular subplots. It is therefore NOT directly comparable to the volumes estimated by the other approaches in this project. 
    

## Results

#### Volume {.tabset}

##### Boxplot
```{r echo = FALSE, eval= TRUE, message = FALSE}

        ggplot(data = subplot_sums, aes(x = Treatment, y = Volume_m3, fill = Treatment)) +
                geom_boxplot() +
                ggtitle("Range of plot volumes for SustHerb study sites") +
                labs(x = "Site Treatment", y = bquote("Summed plot volume"~(m^3)))

```

##### Histogram
```{r echo = FALSE, eval= TRUE, message = FALSE}

        ggplot(data = subplot_sums, aes(x = Volume_m3, fill = Treatment, group = Treatment)) +
                geom_histogram(aes(y=..density..), bins = 30, alpha=1, position="identity") +
                geom_density(alpha= 0.5) +
                ggtitle("Density plot of plot volumes") +
                labs(x = "Summed plot volume (m3)", y = "Density")

```

##### By Study Site
```{r echo = FALSE, eval= TRUE, message = FALSE}

        ggplot(data = subplot_sums, aes(x = Treatment, y = Volume_m3, fill = Treatment)) +
                geom_bar(position="dodge", stat="identity") +
                facet_wrap(~ LocalityName, ncol = 5) +
                ggtitle("Plot volumes for SustHerb study sites") +
                labs(x = "Site Treatment", y = bquote("Summed plot volume"~(m^3)))

        ggplot(data = agg_trees, aes(x = Treatment, y = Volume_m3, fill = Taxa)) +
                geom_bar(position="stack", stat="identity") +
                facet_wrap(~ LocalityName, ncol = 5) +
                ggtitle("Plot volumes for SustHerb study sites (by taxa)") +
                labs(x = "Site Treatment", y = bquote("Summed plot volume"~(m^3)))

```

***

#Albedo Estimates {.tabset .tabset-fade .tabset-pills}

## Reasoning
I used the forest **volume-based version of the albedo model** developed by [Hu et al. (2018)](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2018MS001403) together with snow-water equivalent and temperature data from [seNorge](http://www.senorge.no/) (described earlier) to produce plot-level albedo estimates for the year 2016. The albedo model produces monthly estimates for spruce, pine, and birch forest (which encompasses all other deciduous species). 

I decided that it might be useful to create a **composite albedo** value for each plot (for each month), which would allow for simple comparison of albedos at the plot level. For a given plot in a given month, the first step in creating a composite albedo value is to multiply each species-specific albedo value (produced by the model) with the corresponding species proportions for the plot. This produces three 'fractional albedo' values, which are then summed to produce a 'composite albedo' value:

$$C_{ij} = (A_{ij}S_{jk}) + (A_{ij}S_{jk}) + (A_{ij}S_{jk})\\\;\\C=composite\;albedo\\A = species\mbox{-}specific\;albedo\\S = species\;proportion\\i = month\;(1\mbox{-}12);\;j = plot;\;k = species\;(spruce,\;pine,\;birch)$$

> What do you think about this 'composite albedo'? Is it a reasonable way of assessing albedo across plots?

## Method
1. For a given plot, I ran a function to produce 12 albedo estimates (one for each month of the year)
    + This function incorporated the summed volume (m3) estimate for the plot, as well as 12 values for both average snow-water equivalent (mm) and temperature (K). It used the albedo model form described earlier with species-specific coefficients to produce species-specific albedo estimates for each month of a single year.
    + The function then used the relative proportion of spruce, pine, and birch trees to calculate composite albedos (as described in the reasoning section).
2. For each plot, the function produced a total of *12 composite albedo estimates* (one for each month of the year). Thus, the final albedo dataset contains **360 albedo estimates** (12 per plot, 180 per treatment).

## Results
``` {r echo = FALSE, eval= TRUE, message = FALSE}

        model_data <- read.csv("../../../Approach_1/Output/Albedo_Estimates/albedo_estimates_approach_1.csv")
```

### Albedo {.tabset}

#### Time Series
``` {r echo = FALSE, eval= TRUE, message = FALSE}

        model_data$Month <- as.factor(model_data$Month)
        ggplot(data = model_data, aes(x = Month, y = Composite_Albedo, fill = Treatment)) +
                geom_boxplot() +
                ggtitle("Monthly albedo estimates for SustHerb study sites") +
                labs(x = "Month", y = "Albedo")

```

#### By Site
``` {r echo = FALSE, eval= TRUE, message = FALSE}

        model_data$Month <- as.integer(model_data$Month)
        ggplot(data = model_data, aes(x = Month, y = Composite_Albedo, color = Treatment)) +
                geom_point(alpha = 0.7) +
                geom_line(alpha = 0.3) +
                scale_x_continuous(breaks = c(1,12), limits = c(1,12)) +
                scale_y_continuous(breaks = c(0.0,0.2,0.4,0.6), limits = c(0,0.6)) +
                facet_wrap(~ LocalityName, ncol = 5) +
                ggtitle("Monthly albedo estimates for SustHerb study sites (by site)") +
                labs(x = "Month", y = "Albedo")

```


***

#Model {.tabset .tabset-fade .tabset-pills}

## Correlation Matrix
I created a correlation matrix to investigate possible correlations between continuous explanatory variables (which would ultimately affect the stability of the final model). It appears that *Roe Deer Density* has a relatively strong correlation with moose density.
```{r echo = FALSE, eval= TRUE, message = FALSE}

        ggpairs(data = model_data, columns = c(8:12)) 

```


## Model
Due to the setup of the study design and non-independence of data within each study site (i.e. 2 plots per study site, not independent of each other), I believe we'll need to use a **linear mixed effects model** to model estimated albedo as a function of treatment (moose exclusion). I gave a "first attempt" at a model below - this model was implemented via the *lme4* package in R w/ *lmer* function). As discussed in the 'correlation matrix' section, *Roe Deer Density* was removed as a potential variable due to strong correlation with moose density. I specified the "LocalityName" variable as a random intercept, in order to account for non-independence of data at the level of the study site. The main fixed effect of interest (treatment) was then specified as an interaction with month. 

To select a 'best' model, I started off with a base model with all of the variables of interest, and then eliminated terms that weren't significant. From this 'filtered' model, I created several other versions based on what I thought might be best. I then used the *AIC function* to calculate AIC values for each model. Finally, I chose the model with the lowest AIC value as the 'best' (below).

```{r echo = FALSE, eval= TRUE, message = FALSE}

#Import CSV to dataframe
model_data <- read.csv('../../../Approach_1/Output/Albedo_Estimates/albedo_estimates_approach_1.csv', header = TRUE)
        
        #Format columns
        model_data$Month <- as.factor(model_data$Month)
        model_data$Treatment <- as.factor(model_data$Treatment)
        model_data$LocalityCode <- as.factor(model_data$LocalityCode)
        model_data$LocalityName <- as.factor(model_data$LocalityName)
```

```{r echo = TRUE, eval = FALSE, message = FALSE}
#Initial model:
lmer(Composite_Albedo ~
     Treatment*Month +
     Canopy_Height_MAD +
     Years_Since_Clearcut +
     Moose_Density +
     (1 | LocalityName),
data = model_data)
```

```{r echo = FALSE, eval = TRUE, message = FALSE}
        
#Output
model <- lmer(Composite_Albedo ~
                     Treatment*Month +
                     Canopy_Height_MAD +
                     Years_Since_Clearcut +
                     Moose_Density +
                     (1 | LocalityName),
                data = model_data)
        
tab_model(model, digits = 5)

```

> Is this model correctly specified? Should I be using a non-linear mixed effects model (nlme) instead?

## Diagnosis
It certainly looks like something strange is happening with the residuals. Not sure why there is this linear trend at lower fitted values:

```{r echo = FALSE, eval = TRUE, message = FALSE}

#Output
plot(model)
        
```

***

#Next Steps?

#### Better Model Selection
After looking at the **residuals plot** for the model in the previous section, I'm not convinced that I'm using the correct model. It's clear that the amount of variation in albedo estimates varies substantially by month (ex. the variation in albedo is much greater in December than in July). Do I need to set a specific 'covariance structure' to account for this?

Also, I'm a bit confused about specifying "Month" as a fixed effect vs random effect. We're interested in seeing how treatment (moose exclusion) affects albedo for each month - therefore, it's necessary to add "Month" as a fixed effect together with treatment. However, would it be relevant to add "Month" as a random effect as well/instead? For a given plot, the data from Month 1 will likely be more similar to data from Month 2 than data from Month 8 (i.e. there is non-independence in data across months). How do we handle this?

#### Backfitted Models to Improve Sample Size
I'd really like to use the backfitted height-only biomass models produced by [Kolstad et al. (2017)](https://link.springer.com/article/10.1007/s10021-017-0202-4) to estimate volume (and ultimately, albedo) for a greater number of SustHerb sites, as well as for additional years (not just 2016). I'm planning on doing this, but haven't gotten around to it yet.

#### Variation in Albedo
I'd also like to investigate how treatment (i.e. moose exclusion) affects **variation** in surface albedo. This isn't a parameter I'd considered looking at before, but it would certainly be interesting if moose exclusion has some type of effect on how much albedo varies across a landscape (and may have important climate implications, too). Maybe MAD would be a good metric to look at?

 
 
 